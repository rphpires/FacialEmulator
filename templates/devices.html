{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
  <div class="row align-items-center">
    <div class="col-md-6">
      <h3 class="display-8">Dispositivos</h3>
    </div>
    <div class="col-md-6 text-end">
      <button class="btn btn-outline-success ms-2" onclick="start_emulators()">
        <i class="bi bi-play-fill"></i> Iniciar
      </button>
      <button class="btn btn-outline-danger ms-2" onclick="stop_emulators()">
        <i class="bi bi-stop-fill"></i> Parar
      </button>
    </div>
  </div>

  <table class="table table-striped table-hover mt-3" id="device-table">
    <thead>
      <tr>
        <th scope="col" class="text-center">LocalControllerID</th>
        <th scope="col" class="text-center">Nome</th>
        <th scope="col" class="text-center">Port</th>
        <th scope="col" class="text-center">Event Interval (s)</th>
        <th scope="col" class="text-center">Total Users</th>
        <th scope="col" class="text-center">Commands</th>
        <th scope="col" class="text-center">
          <input type="checkbox" id="select-all" />
        </th>
        <th scope="col" class="text-center">Status</th>
      </tr>
    </thead>
    <tbody>
      {% for dev in devices %}
        <tr id="device_{{ dev.lc_id }}">
          <td class="text-center">{{ dev.lc_id }}</td>
          <td class="text-center">{{ dev.name }}</td>
          <td class="text-center" id="port_no">{{ dev.port }}</td>
          <td class="text-center">{{ dev.interval }}</td>
          <td class="text-center">{{ dev.total }}</td>
          <td class="text-center">
            <a href="#" 
              class="btn btn-outline-success btn-sm {% if dev.status == 'running' %}btn-custom-disabled{% endif %}"
              onclick="startSingleEmulator('{{dev.port}}')">
                <i class="bi bi-play-fill"></i>
            </a>
            <a href="#" 
              class="btn btn-outline-danger btn-sm {% if dev.status == 'stopped' %}btn-custom-disabled{% endif %}"
              onclick="stopSingleEmulator('{{dev.port}}')">
                <i class="bi bi-pause-fill"></i>
            </a>
          </td>
          <td class="text-center">
            <input type="checkbox" class="device-checkbox" />
          </td>
          
          {% if dev.status == 'running' %}
          <td class="text-center">
            <span class="border border-success" style="padding: 5px; border-radius: 5px; color: #117529;">{{ dev.status }}</span>
          </td>
          {% else %}
          <td class="text-center">
            <span class="border border-danger" style="padding: 5px; border-radius: 5px; color: #a70000;">{{ dev.status }}</span>
          </td>
          {% endif %}
          
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="d-flex justify-content-center align-items-center position-relative">
    <!-- Controle de quantidade de itens por página, ao lado esquerdo da paginação -->
    <div class="d-flex align-items-center position-absolute start-0">
      <label for="per-page-select" class="form-label mb-0 me-2">Itens por página:</label>
      <select id="per-page-select" class="form-select" style="width: auto;" onchange="changePerPage()">
        <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
        <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
        <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
      </select>
    </div>
  
    <!-- Paginação centralizada -->
    <nav>
      <ul class="pagination mb-0">
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
          <a class="page-link" href="/?page={{ page-1 }}&per_page={{ per_page }}">Anterior</a>
        </li>
        {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if page == p %}active{% endif %}">
          <a class="page-link" href="/?page={{ p }}&per_page={{ per_page }}">{{ p }}</a>
        </li>
        {% endfor %}
        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
          <a class="page-link" href="/?page={{ page+1 }}&per_page={{ per_page }}">Próxima</a>
        </li>
      </ul>
    </nav>
  </div>
  

</div>

<!-- Script to handle checkbox selection -->
<script>
  function changePerPage() {
    const perPage = document.getElementById('per-page-select').value;
    window.location.href = `/?page=1&per_page=${perPage}`;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const selectAllCheckbox = document.getElementById('select-all');
    const deviceCheckboxes = document.querySelectorAll('.device-checkbox');

    function setAllCheckboxes(checked) {
      deviceCheckboxes.forEach(checkbox => {
        checkbox.checked = checked;
      });
    }
    
    selectAllCheckbox.addEventListener('change', (event) => {
      setAllCheckboxes(event.target.checked);
    });

    deviceCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const allChecked = Array.from(deviceCheckboxes).every(checkbox => checkbox.checked);
        const anyChecked = Array.from(deviceCheckboxes).some(checkbox => checkbox.checked);
        
        // O selectAllCheckbox deve estar marcado se todos os checkboxes individuais estiverem marcados
        selectAllCheckbox.checked = allChecked;
        
        // O selectAllCheckbox deve estar indeterminado se ao menos um checkbox individual estiver marcado, mas não todos
        selectAllCheckbox.indeterminate = !allChecked && anyChecked;
      });
    });
  });

  document.addEventListener('DOMContentLoaded', () => {
    const selectAllCheckbox = document.getElementById('select-all');
    const deviceCheckboxes = document.querySelectorAll('.device-checkbox');

    function setAllCheckboxes(checked) {
      deviceCheckboxes.forEach(checkbox => {
        checkbox.checked = checked;
      });
    }

    // Evento para selecionar todos os checkboxes
    selectAllCheckbox.addEventListener('change', (event) => {
      setAllCheckboxes(event.target.checked);
    });

    // Atualiza o estado do checkbox de seleção geral
    deviceCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        const allChecked = Array.from(deviceCheckboxes).every(checkbox => checkbox.checked);
        selectAllCheckbox.checked = allChecked;
      });
    });

    // Função para obter IDs dos dispositivos selecionados
    function getSelectedDevices() {
      const selectedDevices = [];
      const deviceCheckboxes = document.querySelectorAll('input.device-checkbox');

      deviceCheckboxes.forEach((checkbox) => {
        if (checkbox.checked) {
          const row = checkbox.closest('tr'); // Acessa a linha da tabela
          const portElement = row.querySelector('td#port_no'); // Pega o objeto <td> com o id "port_no"

            if (row) {
              // Encontre o elemento <td> com o ID 'port_no'
              const portElement = row.querySelector('td#port_no');

              if (portElement) {
                // Pegue o valor do texto do <td> e adicione ao array
                const port = portElement.textContent.trim();
                selectedDevices.push(port);
              }
            }
        }
      });
      return selectedDevices;
    }

    // Função chamada ao clicar em "Iniciar"
    window.start_emulators = async () => {
      const selectedDevices = getSelectedDevices();
      if (selectedDevices.length > 0) {
        try {
          const response = await fetch('/start', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ devices: selectedDevices }),
          });

          if (response.ok) {
            alert('Emuladores iniciados com sucesso!');
            window.location.href = '/';  // Redireciona após sucesso
          } else {
            alert('Falha ao iniciar emuladores.');
          }
        } catch (error) {
          console.error('Erro ao iniciar emuladores:', error);
          alert('Erro ao iniciar emuladores.');
        }
      } else {
        alert('Nenhum dispositivo selecionado.');
      }
    };

    // Função chamada ao clicar em "Parar"
    window.stop_emulators = async () => {
      const selectedDevices = getSelectedDevices();
      if (selectedDevices.length > 0) {
        try {
          const response = await fetch('/stop', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ devices: selectedDevices }),
          });

          if (response.ok) {
            alert('Emuladores parados com sucesso!');
            window.location.href = '/';  // Redireciona após sucesso
          } else {
            alert('Falha ao parar emuladores.');
          }
        } catch (error) {
          console.error('Erro ao parar emuladores:', error);
          alert('Erro ao parar emuladores.');
        }
      } else {
        alert('Nenhum dispositivo selecionado.');
      }
    };
  });

  function startSingleEmulator(port) {
    fetch('/start', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ devices: [port] }),
    })
    .catch(error => {
      console.error(`Erro ao iniciar o emulador na porta ${port}:`, error);
      alert(`Erro ao iniciar o emulador na porta ${port}.`);
    });
  }

  function stopSingleEmulator(port) {
    fetch('/stop', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ devices: [port] }),
    })
    .catch(error => {
      console.error(`Erro ao parar o emulador na porta ${port}:`, error);
      alert(`Erro ao parar o emulador na porta ${port}.`);
    });
  }

  const socket = io();
  socket.on('update_device_status', function(data) {
    console.log('Recebido:', data);

    const deviceRow = document.querySelector(`#device_${data.device_id}`);
    console.log('Selecionado:', deviceRow);

    if (deviceRow) {
      // Atualiza o conteúdo da linha da tabela com o HTML fornecido
      deviceRow.innerHTML = data.updated_html;
      console.log('Linha atualizada com sucesso.');
    } else {
      console.log('Linha não encontrada:', data.device_id);
    }
  });

</script>


<style>
  .btn-custom-disabled {
    background-color: #d3d3d3; /* Cinza claro */
    border-color: #d3d3d3; /* Cinza claro */
    color: #a9a9a9; /* Cinza escuro para o texto */
    cursor: not-allowed;
  }

  .btn-custom-disabled i {
    color: #a9a9a9; /* Cinza escuro para o ícone */
  }

  .btn-custom-disabled:hover {
    background-color: #d3d3d3; /* Mantém a cor cinza claro ao passar o mouse */
    border-color: #d3d3d3; /* Mantém a cor cinza claro ao passar o mouse */
  }
</style>

{% endblock %}
